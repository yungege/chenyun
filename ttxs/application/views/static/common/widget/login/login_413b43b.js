define("common:widget/login/login.js",function(e,i){function t(){this.tpl=['<div class="login-dialog">','<div class="title">',"<h3>登录</h3>",'<span class="close"></span>',"</div>",'<div class="login-content">','<div class="login-form need-verify-code">','<div class="input-group top">','<div class="notice up">用户名或密码错误</div>','<label for="username" class="username-label icon"></label>','<input type="text" placeholder="手机号/邮箱" class="username">',"</div>",'<div class="input-group">','<label for="password" class="password-label icon"></label>','<input type="password" placeholder="密码" class="password">',"</div>",'<div class="verify-code">','<div class="notice ver">验证码错误</div>','<div class="verify-box">','<input type="text" class="code" placeholder="验证码">','<img src="/home/interface/getverifycode" class="verify-code-img">','<span class="refush-code">换一张</span>',"</div>","</div>",'<div class="line">','<i class="checkbox icon rember"></i>',"记住我",'<a href="/findpasswd.html">忘记密码</a>',"</div>",'<button class="login-btn">登 录</button>','<p>还没有账号？<a href="/register.html">立即注册</a></p>','<p class="third-login">其他登录方式：','<a href="/oauth2/auth.html?type=qq" title="使用QQ登录"><i class="icon qq-icon"></i></a>','<a href="/oauth2/auth.html?type=wechat" title="使用微信登录"><i class="icon wechat-icon"></i></a>','<a href="/oauth2/auth.html?type=weibo" title="使用微博登录"><i class="icon weibo-icon"></i></a>',"</p>","</div>",'<div class="scan">','<div class="scan-code code-loading">',"</div>",'<a href="/topic/app">下载客户端</a>',"<p>扫一扫 自动登录</p>","</div>","</div>","</div>"].join(""),this.init()}var o=e("common:widget/dialog/dialog.js"),s=e("common:widget/checkbox/checkbox.js"),n=e("common:widget/lib/jquery.js"),a=e("common:widget/qrcode/qrcode.js"),c=e("common:widget/cookie/cookie.js"),r=e("common:widget/code/code.js");t.prototype={init:function(){this.createDialog(),this.getDom(),this.declare(),this.renderCode(),this.focusEvent(),this.blurEvent(),this.loginBtnEvent(),this.showVerifyCode(),this.refushCodeEvent(),this.listenEnter(),this.listenScan()},listenScan:function(){var e=this;this.timer=setInterval(function(){n.getJSON("/home/interface/checklogin",function(i){0===i.status.code&&(clearInterval(e.timer),window.location.reload())})},this.timeDelay),this.closeBtn.click(function(){clearInterval(e.timer)})},listenEnter:function(){var e=this;n(window).on("keydown",function(i){13===i.keyCode&&e.loginEvent()})},refushCodeEvent:function(){var e=this.verifyImg.attr("src"),i=this;this.verifyImgFlushBtn.unbind().click(function(){var t=+new Date;i.verifyImg.attr("src",e+"?t="+t)})},showVerifyCode:function(){this.needVerifyCode&&this.verifyWarp.slideDown()},setErrorTimes:function(){var e=new Date,i=e.getFullYear(),t=e.getMonth()+1,e=e.getDate()+1,o=new Date(i+"/"+t+"/"+e),s=void 0===c.cookie.get("p_et")?1:parseInt(c.cookie.get("p_et"),10)+1;c.cookie.set("p_et",s,{path:"/",domain:document.domain,expires:o})},loginBtnEvent:function(){var e=this;this.loginBtn.unbind().click(function(){e.loginEvent()})},loginEvent:function(){var e=this;return this.validate()?void(this.needVerifyCode?n.getJSON("/home/interface/verifycode?code="+e.verifyCode.val(),function(i){0===i.status.code?e.loginCoreEvent():e.verNotice.html(r.code[i.status.code]).addClass(e.noticeShowClass)}):this.loginCoreEvent()):!1},loginCoreEvent:function(){var e=this,i=this.checkStatus.getStatus("rember")?1:0;n.ajax({url:"/home/interface/login",type:"post",data:{username:this.username.val(),password:this.password.val(),autologin:i},success:function(i){0===i.status.code?window.location.reload():(e.setErrorTimes(),-10===i.status.code?e.verNotice.html(r.code[i.status.code]).addClass(e.noticeShowClass):e.upNotice.html(r.code[i.status.code]).addClass(e.noticeShowClass))}})},blurEvent:function(){var e=this;this.input.on("blur",function(){e.validate()})},validate:function(){var e=/^1\d{10}$/,i=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/,t=/^\w{4}$/;return e.test(this.username.val())||i.test(this.username.val())?this.password.val().length<8?(this.upNotice.html("密码长度不符").addClass(this.noticeShowClass),!1):this.needVerifyCode&&!t.test(this.verifyCode.val())?(this.verNotice.html("验证码格式错误").addClass(this.noticeShowClass),!1):!0:(this.upNotice.html("账号格式不符").addClass(this.noticeShowClass),!1)},focusEvent:function(){var e=this;this.input.on("focus",function(){e.upNotice.removeClass(e.noticeShowClass),e.verNotice.removeClass(e.noticeShowClass)})},renderCode:function(){var e=window.domain+"/home/interface/scanlogin?sessid="+c.cookie.get("ck_dayinji");a.qrcode({picker:this.codeContainer,width:150,height:150,text:e})},declare:function(){this.errorCount=0,this.noticeShowClass="show",this.checkStatus=new s.checkbox(".rember"),this.needVerifyCode=void 0===c.cookie.get("p_et")||parseInt(c.cookie.get("p_et"),10)<3?!1:!0,this.timer=null,this.timeDelay=3e3},getDom:function(){this.container=n(".login-dialog"),this.username=this.container.find(".username"),this.password=this.container.find(".password"),this.loginBtn=this.container.find("button"),this.upNotice=this.container.find(".up"),this.verNotice=this.container.find(".ver"),this.verifyWarp=this.container.find(".verify-code"),this.verifyCode=this.container.find(".code"),this.verifyImg=this.container.find(".verify-code-img"),this.verifyImgFlushBtn=this.container.find(".refush-code"),this.input=this.container.find("input"),this.closeBtn=this.container.find(".close"),this.codeContainer=this.container.find(".scan-code")},createDialog:function(){this.dialog=new o.dialog({width:734,height:406,tpl:this.tpl,close:".login-dialog .close"})}},i.login=t});