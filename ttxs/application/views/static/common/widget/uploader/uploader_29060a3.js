define("common:widget/uploader/uploader.js",function(e,t){var i=e("common:widget/lib/jquery.js"),o=e("common:widget/uploader/parsemd5.js"),n=e("common:widget/alert/alert.js"),r=function(){try{var e=(new FormData,new FileReader);return e.readAsBinaryString&&e.readAsArrayBuffer?!0:!1}catch(t){return!1}},s=function(e){return r()?(this.options={picker:"",allowType:[],multiple:!0,onUpload:"",formDataParams:"",uploadUrl:"",checkFileMd5:!1,checkFileMd5Url:"",checkFileMd5Params:"md5",progress:"",success:"",error:""},this.options=this.merge(this.options,e),void this.init()):(new n.alert({title:"浏览器版本过低，无法进行上传，请升级",type:"danger",button:!0,confirmCallBack:function(){window.location.href="/browse.html"}}),i(e.picker).addClass("unclick"),{})};s.prototype={merge:function(e,t){for(var i in e)void 0!=t[i]&&(e[i]=t[i]);return e},constructor:"zeegine Web Uploader"+ +new Date,declare:function(){this.uploaderToken="uploader"+ +new Date+parseInt(100*Math.random(),10),this.uploader=null,this.fileTypeLegal=-1,this.uploadError=-2,this.uploadTimeout=-3,this.serverError=-4},createUploader:function(){if(this.options.multiple)var e='<input type="file" id="'+this.uploaderToken+'" multiple="multiple" style="display:none">';else var e='<input type="file" id="'+this.uploaderToken+'" style="display:none">';i("body").append(e),this.uploader=document.getElementById(this.uploaderToken)},destroy:function(){i(this.uploader).remove(),this.picker.unbind("click")},init:function(){this.declare(),this.createUploader(),this.getDom(),this.initUploader(),this.listenUploadFile()},listenUploadFile:function(){var e=this;this.uploader.addEventListener("change",function(){e.onUploadEvent(this.files)},!1)},error:function(e,t,i){var o={type:e,errstr:t,fileInfo:i};if("function"!=typeof this.options.error)throw new Error("File type is not legal");this.options.error.call(this,o)},success:function(e,t){"function"==typeof this.options.success&&(e.fileId=t.data.fileId,t.data.location&&(e.location=t.data.location),this.options.success.call(this,e))},startUploadFile:function(e){var t=this,o=new XMLHttpRequest,n=new FormData,r=e.token;o.upload.addEventListener("progress",function(e){"function"==typeof t.options.progress&&(e.token=r,t.options.progress.call(this,e))},!1),o.addEventListener("readystatechange",function(){if(4===o.readyState)if(200===o.status){var n=i.parseJSON(o.responseText);0===n.status.code?t.success(e,n):t.error(t.serverError,"服务器接收失败",e)}else t.error(t.uploadTimeout,"上传超时",e)},!1),o.addEventListener("error",function(){t.error(t.uploadError,"上传失败",e)},!1),n.append("fileName",e.name),n.append("fileType",e.parseType),n.append("fileSize",e.size),n.append("md5",e.md5),n.append("sendStamp",+new Date),n.append(this.options.formDataParams,e),o.open("POST",this.options.uploadUrl,!0),o.send(n)},checkFileMd5:function(e){var t=this;this.options.checkFileMd5?i.getJSON(this.options.checkFileMd5Url+"?"+this.options.checkFileMd5Params+"="+e.md5,function(i){0===i.status.code?("function"==typeof t.options.progress&&t.options.progress.call(this,{loaded:100,total:100,token:e.token}),t.success(e,i)):t.startUploadFile(e)}):this.startUploadFile(e)},checkFileType:function(e){var t=!1,i=e.type?e.type:e.name.substring(e.name.lastIndexOf(".")+1).toLowerCase();if(this.options.allowType.length>0){for(var o=0;o<this.options.allowType.length;o++)if(i.indexOf(this.options.allowType[o])>-1||this.options.allowType[o].indexOf(i)>-1||this.options.allowType[o]==i){e.parseType=this.options.allowType[o],t=!0;break}}else t=!0;return t?("function"==typeof this.options.onUpload&&this.options.onUpload.call(this,e),void this.checkFileMd5(e)):this.error(this.fileTypeLegal,e.name+"文件类型不合法",e)},onUploadEvent:function(e){for(var t=this,i=0;i<e.length;i++)!function(){var n=new o.parsemd5,r=e[i],s=new FileReader;s.readAsBinaryString(r),s.addEventListener("load",function(){n.appendBinary(this.result),r.md5=n.end(),r.token=+new Date,t.checkFileType(r)},!1)}();this.uploader.innerHTML="",this.uploader.value=""},initUploader:function(){var e=this;this.picker.unbind().click(function(){e.uploader.click()})},getDom:function(){if(this.picker=i(this.options.picker),0===this.picker.length)throw new Error("unkonw picker")}},t.uploader=s});