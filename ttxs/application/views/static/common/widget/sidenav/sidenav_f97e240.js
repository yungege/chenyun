define("common:widget/sidenav/sidenav.js",function(t,e){var n=t("common:widget/lib/jquery.js"),s=t("common:widget/code/code.js"),i=t("common:widget/dialog/dialog.js"),a=t("common:widget/lib/html2canvas.js"),o={feedbackTpl:['<div class="feedback-dialog">','<div class="title">',"<h1>用户反馈</h1>",'<span class="feedback-close"></span>',"</div>",'<div class="context">',"<h2>打印基的每一个进步，都离不开您的意见与建议</h2>",'<p class="notice feedback-content-notice">请您输入要反馈的内容</p>','<textarea class="feedback-content" placeholder="请留下您的反馈信息，每条反馈我们都会认真阅读，并且尽快联系您。（不少于5个字）"></textarea>','<input class="feedback-contact" placeholder="请输入您的QQ／手机／邮箱，以便我们回复您">','<div class="screenshot">','<div class="screenshot-warp">','<button class="screenshot-btn">截屏</button>',"<p>文字表达不清，上传张图片吧！</p>","</div>",'<div class="screenshot-img" data-pic-id="">','<span class="remove-screenshot-img-btn"></span>','<img src="">',"</div>","</div>",'<div class="btn-box">','<button class="submit">提交</button>',"</div>","</div>","</div>"].join(""),successTpl:['<div class="feedback-success">','<span class="close"></span>','<b class="success-icon"></b>','<div class="message">',"<p>您的反馈已经成功提交</p>","<p>感谢您的反馈，您的支持是我们最大的动力！</p>","</div>",'<button class="close">关闭</button>',"</div>"].join(""),declare:function(){this.toolsShow=!1,this.feedbackBtn=null,this.dialog=null,this.timer=null,this.canvas=null,this.hasShotImage=!1,this.submitLock=!1,this.fileIdAttr="data-pic-id"},init:function(){var t=this;this.declare(),this.getDom(),this.parsePosition(),n(window).on("resize",function(){t.parsePosition()})},feedbackEvent:function(){var t=this;this.feedbackBtn.unbind().click(function(){return t.dialog=new i.dialog({width:736,height:589,tpl:t.feedbackTpl,close:".feedback-close"}),t.getFeedbackDom(),t.screenShowEvent(),t.submitEvent(),!1})},drawChoiceArea:function(){var t=this.doc.height(),e=this.doc.width(),s=n("<canvas>");s.attr({height:t,width:e}).attr("id","feedback-drow-canvas"),this.page.append(s);var i=document.getElementById("feedback-drow-canvas");this.canvas=i.getContext("2d"),this.initCanvas(e,t),this.initMouseDraw(e,t,s),this.shotBtnEvent(e,t,s),this.removeShotImageEvent()},removeShotImageEvent:function(){var t=this;this.screenShotViewRemoveBtn.unbind().click(function(){t.hasShotImage=!1,t.screenShotViewWarp.hide(),t.screenShotHandlerWarp.show(),t.screenShotViewImage.attr("src","")})},shotBtnEvent:function(t,e,n){var s=this;this.confrimShotBtn.unbind().click(function(t){a.html2canvas(s.page,{onrendered:function(t){n.remove(),s.canvas=null,s.dialog.showDialog(),s.screenShotTarget.hide(),s.screenShotViewWarp.show(),s.screenShotHandlerWarp.hide(),s.screenShotViewImage.attr("src",t.toDataURL("image/png")),s.hasShotImage=!0}}),t.stopPropagation()}),this.cancelShotBtn.unbind().click(function(t){n.remove(),s.canvas=null,s.screenShotTarget.hide(),s.dialog.showDialog(),t.stopPropagation()}),this.reShotBtn.unbind().click(function(n){s.canvas.clearRect(0,0,t,e),s.canvas.fillRect(0,0,t,e),s.screenShotTarget.hide(),n.stopPropagation()})},initMouseDraw:function(t,e,n){var s=this,i=0,a=0,o=0,c=0;n.on("mousedown",function(n){i=n.pageX,a=n.pageY,s.screenShotTarget.hide(),s.doc.on("mousemove",function(n){o=n.pageX,c=n.pageY,s.canvas.clearRect(0,0,t,e),s.canvas.fillRect(0,0,t,e),s.canvas.clearRect(i,a,o-i,c-a),s.canvas.strokeRect(i,a,o-i,c-a)})}).on("mouseup",function(){s.doc.unbind("mousemove"),s.screenShotTarget.css({left:o>i?i:o,top:c>a?a:c,width:Math.abs(o-i),height:Math.abs(c-a)}).show()})},initCanvas:function(t,e){this.canvas.fillStyle="rgba(0, 0, 0, 0.6)",this.canvas.strokeStyle="#ff0000",this.canvas.linewidth=1,this.canvas.fillRect(0,0,t,e)},screenShowEvent:function(){var t=this;this.screenShotBtn.click(function(){t.dialog.hideDialog(),t.drawChoiceArea()})},sendAsyncRequest:function(){var t=this,e="";this.hasShotImage&&(e=this.screenShotViewWarp.attr(this.fileIdAttr)),n.ajax({url:"/home/submit/feedback",type:"post",data:{content:this.content.val(),contact:this.contact.val(),pic_id:e},success:function(e){0===e.status.code?new i.dialog({width:410,height:200,tpl:t.successTpl,close:".close"}):t.notice.html(s.code[e.status.code]).addClass("show")}})},uploadImageEvent:function(){var t=this,e=new FormData,s=new XMLHttpRequest;this.submitLock=!0,this.notice.html("正在上传图片，请耐心等待").addClass("success"),s.addEventListener("readystatechange",function(){if(4===s.readyState&&200===s.status){var e=n.parseJSON(s.responseText);0===e.status.code?(t.screenShotViewWarp.attr(t.fileIdAttr,e.data.fileId),t.sendAsyncRequest()):(t.screenShotViewWarp.attr(t.fileIdAttr,""),new A.alert({type:"danger",title:"图片上传失败！请重试"}))}},!1),e.append("pic",this.screenShotViewImage.attr("src")),s.open("POST","/home/submit/uploadpic",!0),s.send(e)},submitEvent:function(){var t=this;this.content.on("focus",function(){t.notice.removeClass("show")}),this.submitBtn.unbind().click(function(){return t.submitLock?!1:t.content.val().length<5||t.content.val().length>200?(t.notice.html("请您输入要反馈的内容，最少5个字，最多200字").addClass("show"),!1):void(t.hasShotImage?t.uploadImageEvent():t.sendAsyncRequest())})},getFeedbackDom:function(){this.warp=n(".feedback-dialog"),this.content=this.warp.find(".feedback-content"),this.contact=this.warp.find(".feedback-contact"),this.screenShotHandlerWarp=this.warp.find(".screenshot-warp"),this.screenShotBtn=this.warp.find(".screenshot-btn"),this.screenShotViewWarp=this.warp.find(".screenshot-img"),this.screenShotViewRemoveBtn=this.screenShotViewWarp.find("span"),this.screenShotViewImage=this.screenShotViewWarp.find("img"),this.notice=this.warp.find(".notice"),this.submitBtn=this.warp.find(".submit"),this.doc=n(document),this.page=n("body")},topEvent:function(){this.gotopBtn.unbind().click(function(){return n("html, body").stop().animate({scrollTop:0}),!1})},scrollEvent:function(){if(!this.toolsShow)return!1;var t=this,e=0;n(window).on("scroll",function(){e=parseInt(n(window).scrollTop(),10),0===e&&t.gotopBtn.is(":visible")?t.gotopBtn.fadeOut():t.gotopBtn.is(":visible")||t.gotopBtn.fadeIn()})},parsePosition:function(){var t=parseInt(n(window).width(),10),e=(t-1300)/2-62;e>0?(this.toolsShow=!0,this.container.css("right",e),this.container.fadeIn(),this.feedbackBtn=this.bigScreenFeedbackBtn,this.smallScreenFeedbackBtn.hide()):(this.feedbackBtn=this.smallScreenFeedbackBtn,this.feedbackBtn.fadeIn(),this.container.hide()),this.scrollEvent(),this.topEvent(),this.feedbackEvent()},getDom:function(){this.container=n(".side-nav"),this.bigScreenFeedbackBtn=n(".big-screen-feedback"),this.smallScreenFeedbackBtn=n(".small-screen-feedback"),this.gotopBtn=this.container.find(".gotop"),this.screenShotTarget=n(".screenshot-target"),this.confrimShotBtn=this.screenShotTarget.find(".submit-shot-btn"),this.reShotBtn=this.screenShotTarget.find(".re-shot-btn"),this.cancelShotBtn=this.screenShotTarget.find(".cancel-shot-btn")}};e.sidenav=o});