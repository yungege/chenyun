define("common:widget/view/view.js",function(e,s){var t=e("common:widget/lib/jquery.js"),o=e("common:widget/alert/alert.js"),r=e("common:widget/view/support.js");if(r.support.checkWebGl())var i=e("common:widget/view/parsestl.js"),n=e("common:widget/view/parseobj.js"),d=e("common:widget/view/parsejson.js"),a=e("common:widget/view/render.js");var p={},l=function(e){if(!r.support.checkWebGl())return{};if(!e.renderEle)throw new Error("params error cant not found renderEle");return window.view&&window.view.destroy(),window.view=new l.fn.init(e)};l.fn=l.prototype={declare:function(){this.render=null,this.setParmas={},this.stop=null},set:function(e){this.setParmas=e},clearRenderWarp:function(){for(var e in this.hideEle)this.hideEle[e].hide();this.renderEle.show()},init:function(e){this.options=e,"object"==typeof this.options.set&&this.set(this.options.set),this.declare(),this.getDom(),this.clearRenderWarp(),this.loadModelFile()},renderModel:function(e){this.render=new a.render({renderEle:this.renderEle,geometry:this.geometry,renderType:e,debug:this.options.debug?!0:!1,setParams:this.setParmas,screenshot:this.options.screenshot?!0:!1});var s=this,t=function(){s.stop=requestAnimationFrame(t),s.render.startRender()};t(),"function"==typeof this.options.renderDone&&this.options.renderDone.call(this,this.render.renderer)},parseModelFile:function(e,s){switch(s){case"stl":this.geometry=i.parsestl.parse(e);break;case"obj":this.geometry=n.parseobj.parse(e);break;case"json":this.geometry=d.parsejson.parse(e);break;default:throw new Error("unspect "+s+"parse")}!p[this.options.modelId]&&this.options.modelId&&(p[this.options.modelId]={geometry:this.geometry,type:s}),this.renderModel(s)},loadModelFile:function(){if(this.options.file&&this.options.type)return this.parseModelFile(this.options.file,this.options.type);if(p[this.options.modelId])this.geometry=p[this.options.modelId].geometry,this.renderModel(p[this.options.modelId].type);else{this.renderEle.append(this.progressLoadTpl);var e=this;t.getJSON("/home/interface/getmodelinfo?model_id="+encodeURIComponent(this.options.modelId),function(s){0===s.status.code&&e.progressGetModelFile(s.data.file_size,s.data.type)})}},progressGetModelFile:function(e,s){var i=new XMLHttpRequest,n="/home/interface/getrendermodel?model_id="+encodeURIComponent(this.options.modelId),d=this,a=0,p=!1,l=-45,h=-225,c=t(".view-progress-box"),m=c.find(".progress-number"),f=c.find(".left-round .progress"),g=c.find(".right-round .progress");i.addEventListener("progress",function(s){a=parseInt(s.loaded/e*100,10),m.html(a+"%"),50>a?g.css("transform","rotate("+(l+a/50*180)+"deg)"):(p||(g.css("transform","rotate("+(l+180)+"deg)"),p=!0),f.css("transform","rotate("+(h+(a-50)/50*180)+"deg)"))},!1),i.addEventListener("load",function(e){f.css("transform","rotate(-45deg)"),g.css("transform","rotate(-225deg)"),m.html("渲染中……").css("font-size","26px"),d.parseModelFile(e.target.response,s)},!1),i.addEventListener("error",function(){new o.alert({type:"danger",title:"请求错误，请使用最新版Chrome进行预览"})},!1),"stl"===s&&r.support.checkXhr2()?i.responseType="arraybuffer":i.overrideMimeType("text/plain; charset=x-user-defined"),i.open("GET",n,!0),i.send(null)},progressLoadTpl:['<div class="view-progress-box">','<div class="progress-show">','<span class="progress-number">0%</span>','<div class="left-round">','<span class="bg"></span>','<span class="progress"></span>',"</div>",'<div class="right-round">','<span class="bg"></span>','<span class="progress"></span>',"</div>","</div>","</div>"].join(""),destroy:function(){this.render&&this.render.destroy(),null!=this.stop&&window.cancelAnimationFrame(this.stop),this.renderEle.html(""),delete window.view,console.log("webgl destroy && deallocate")},getDom:function(){if(this.renderEle=t(this.options.renderEle),!this.renderEle)throw new Error("can not found render warp");if(this.options.hideEle)if(this.hideEle=[],"object"==typeof this.options.hideEle&&!this.options.hideEle instanceof t)for(var e in this.options.hideEle)this.hideEle.push(t(this.options.hideEle[e]));else this.hideEle.push(t(this.options.hideEle))}},l.fn.init.prototype=l.fn,s.view=l});