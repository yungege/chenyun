define("common:widget/view/view.js",function(e,t){var s=e("common:widget/lib/jquery.js"),o=e("common:widget/alert/alert.js"),r=e("common:widget/view/support.js");if(r.support.checkWebGl())var i=e("common:widget/view/parsestl.js"),n=e("common:widget/view/parseobj.js"),d=e("common:widget/view/render.js");var l={},a=function(e){if(!r.support.checkWebGl())return{};if(!e.renderEle)throw new Error("params error cant not found renderEle");return window.view&&window.view.destroy(),window.view=new a.fn.init(e)};a.fn=a.prototype={declare:function(){this.render=null,this.setParmas={},this.stop=null},set:function(e){this.setParmas=e},clearRenderWarp:function(){for(var e in this.hideEle)this.hideEle[e].hide();this.renderEle.show()},init:function(e){this.options=e,"object"==typeof this.options.set&&this.set(this.options.set),this.declare(),this.getDom(),this.clearRenderWarp(),this.loadModelFile()},renderModel:function(e){this.render=new d.render({renderEle:this.renderEle,geometry:this.geometry,renderType:e,debug:this.options.debug?!0:!1,setParams:this.setParmas,screenshot:this.options.screenshot?!0:!1});var t=this,s=function(){t.stop=requestAnimationFrame(s),t.render.startRender()};s(),"function"==typeof this.options.renderDone&&this.options.renderDone.call(this,this.render.renderer)},parseModelFile:function(e,t){switch(t){case"stl":this.geometry=i.parsestl.parse(e);break;case"obj":this.geometry=n.parseobj.parse(e);break;default:throw new Error("unspect "+t+"parse")}!l[this.options.modelId]&&this.options.modelId&&(l[this.options.modelId]={geometry:this.geometry,type:t}),this.renderModel(t)},loadModelFile:function(){if(this.options.file&&this.options.type)return this.parseModelFile(this.options.file,this.options.type);if(l[this.options.modelId])this.geometry=l[this.options.modelId].geometry,this.renderModel(l[this.options.modelId].type);else{this.renderEle.append(this.progressLoadTpl);var e=this;s.getJSON("/home/interface/getmodelinfo?model_id="+encodeURIComponent(this.options.modelId),function(t){0===t.status.code&&e.progressGetModelFile(t.data.file_size,t.data.type)})}},progressGetModelFile:function(e,t){var i=new XMLHttpRequest,n="/home/interface/getrendermodel?model_id="+encodeURIComponent(this.options.modelId),d=this,l=0,a=!1,p=-45,h=-225,c=s(".view-progress-box"),m=c.find(".progress-number"),f=c.find(".left-round .progress"),g=c.find(".right-round .progress");i.addEventListener("progress",function(t){l=parseInt(t.loaded/e*100,10),m.html(l+"%"),50>l?g.css("transform","rotate("+(p+l/50*180)+"deg)"):(a||(g.css("transform","rotate("+(p+180)+"deg)"),a=!0),f.css("transform","rotate("+(h+(l-50)/50*180)+"deg)"))},!1),i.addEventListener("load",function(e){f.css("transform","rotate(-45deg)"),g.css("transform","rotate(-225deg)"),m.html("渲染中……").css("font-size","26px"),d.parseModelFile(e.target.response,t)},!1),i.addEventListener("error",function(){new o.alert({type:"danger",title:"请求错误，请使用最新版Chrome进行预览"})},!1),"stl"===t&&r.support.checkXhr2()?i.responseType="arraybuffer":i.overrideMimeType("text/plain; charset=x-user-defined"),i.open("GET",n,!0),i.send(null)},progressLoadTpl:['<div class="view-progress-box">','<div class="progress-show">','<span class="progress-number">0%</span>','<div class="left-round">','<span class="bg"></span>','<span class="progress"></span>',"</div>",'<div class="right-round">','<span class="bg"></span>','<span class="progress"></span>',"</div>","</div>","</div>"].join(""),destroy:function(){this.render&&this.render.destroy(),null!=this.stop&&window.cancelAnimationFrame(this.stop),this.renderEle.html(""),delete window.view,console.log("webgl destroy && deallocate")},getDom:function(){if(this.renderEle=s(this.options.renderEle),!this.renderEle)throw new Error("can not found render warp");if(this.options.hideEle)if(this.hideEle=[],"object"==typeof this.options.hideEle&&!this.options.hideEle instanceof s)for(var e in this.options.hideEle)this.hideEle.push(s(this.options.hideEle[e]));else this.hideEle.push(s(this.options.hideEle))}},a.fn.init.prototype=a.fn,t.view=a});